<div>

    <div class="container">
        <div class="div-header">
            <button mat-icon-button (click)="goBack()" aria-label="Voltar">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <h1 class="page-title">Pesquisa</h1>
        </div>

        <div>

            <!-- Filtros -->
            <section class="filter-section mat-elevation-z1">
                <h2 class="section-title">Filtros</h2>

                <div class="filter-container">

                    <mat-form-field appearance="fill" class="filter-field">
                        <mat-label>Título</mat-label>
                        <input matInput [(ngModel)]="filters.title" placeholder="Digite o título" />
                        <mat-icon matPrefix>assignment</mat-icon>
                    </mat-form-field>

                    <div class="form-row">
                        <mat-form-field appearance="fill" class="filter-field">
                            <mat-label>Disciplina</mat-label>
                            <mat-select [(ngModel)]="filters.courseId" placeholder="Selecione uma disciplina">
                                <mat-option [value]="null"></mat-option>
                                <mat-option *ngFor="let course of courses" [value]="course.id">
                                    {{ course.name }}
                                </mat-option>
                            </mat-select>
                            <mat-icon matPrefix>menu_book</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="fill" class="filter-field">
                            <mat-label>Professor</mat-label>
                            <mat-select [(ngModel)]="filters.teacherId" placeholder="Selecione um professor">
                                <mat-option [value]="null"></mat-option>
                                <mat-option *ngFor="let teacher of teachers" [value]="teacher.id">
                                    {{ teacher.name }}
                                </mat-option>
                            </mat-select>
                            <mat-icon matPrefix>school</mat-icon>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="fill" class="filter-field">
                            <mat-label>Data Inicial de Deadline</mat-label>
                            <input matInput [matDatepicker]="startPicker" [(ngModel)]="filters.initialDeadline" />
                            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                            <mat-datepicker #startPicker></mat-datepicker>
                            <mat-icon matPrefix>calendar_today</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="fill" class="filter-field">
                            <mat-label>Data Final de Deadline</mat-label>
                            <input matInput [matDatepicker]="endPicker" [(ngModel)]="filters.finalDeadline" />
                            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                            <mat-datepicker #endPicker></mat-datepicker>
                            <mat-icon matPrefix>event</mat-icon>
                        </mat-form-field>
                    </div>

                    <div class="filter-actions">
                        <button mat-raised-button color="primary" (click)="search()">
                            <mat-icon>search</mat-icon> Pesquisar
                        </button>

                        <button mat-raised-button color="primary" (click)="clear()"
                            [disabled]="!filters.title && !filters.courseId && !filters.teacherId && !filters.initialDeadline && !filters.finalDeadline">
                            <mat-icon>clear</mat-icon> Limpar
                        </button>
                    </div>
                </div>

            </section>

            <!-- Seção de Resultados -->
            <section class="results-section mat-elevation-z1">
                <!-- Ações -->
                <div class="action-bar">
                    <button mat-raised-button color="primary" (click)="navigateToCreate()"
                        [disabled]="isAnySelected() || !isAdminUser">
                        <mat-icon>add</mat-icon> Adicionar
                    </button>

                    <button mat-raised-button color="primary" [matMenuTriggerFor]="actionsMenu"
                        [disabled]="!isAnySelected()">
                        <mat-icon>more_vert</mat-icon> Ações
                    </button>

                    <mat-menu #actionsMenu="matMenu">
                        <button mat-menu-item *ngIf="isStudentUser" [disabled]="!canAnswer() || !isOneSelected()"
                            (click)="answer()">
                            <mat-icon>assignment</mat-icon>
                            <span>Responder</span>
                        </button>
                        <button mat-menu-item *ngIf="isAdminUser" [disabled]="!canFinish()" (click)="finishResearch()">
                            <mat-icon>lock</mat-icon>
                            <span>Finalizar pesquisa</span>
                        </button>
                        <button mat-menu-item *ngIf="!isStudentUser" [disabled]="!isOneSelected() || !isFinished()"
                            (click)="viewResearchResults(selectedResearch!)">
                            <mat-icon>bar_chart</mat-icon>
                            <span>Visualizar resultados</span>
                        </button>
                        <button mat-menu-item *ngIf="isAdminUser" [disabled]="!isOneSelected()"
                            (click)="viewResearch(selectedResearch!)">
                            <mat-icon>visibility</mat-icon>
                            <span>Visualizar</span>
                        </button>
                        <button mat-menu-item *ngIf="isAdminUser" [disabled]="!isOneSelected()"
                            (click)="editResearch(selectedResearch!)">
                            <mat-icon>edit</mat-icon>
                            <span>Editar</span>
                        </button>
                        <button mat-menu-item *ngIf="isAdminUser" (click)="deleteResearch()">
                            <mat-icon>delete</mat-icon>
                            <span>Excluir</span>
                        </button>
                    </mat-menu>
                </div>

                <!-- Tabela -->
                <div class="grid-container">
                    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8 full-width-table">

                        <!-- Coluna de Seleção -->
                        <ng-container matColumnDef="select">
                            <th mat-header-cell *matHeaderCellDef>
                                <mat-checkbox [disabled]="!hasData()" (change)="toggleAllRows($event)"
                                    [checked]="isAllSelected()"
                                    [indeterminate]="selection.hasValue() && !isAllSelected()"
                                    color="primary"></mat-checkbox>
                                Marcar
                            </th>
                            <td mat-cell *matCellDef="let row">
                                <mat-checkbox (click)="$event.stopPropagation()" (change)="toggleRow(row)"
                                    [checked]="selection.isSelected(row)" color="primary"></mat-checkbox>
                            </td>
                        </ng-container>

                        <!-- Título -->
                        <ng-container matColumnDef="title">
                            <th mat-header-cell *matHeaderCellDef>Título</th>
                            <td mat-cell *matCellDef="let element">{{ element.title }}</td>
                        </ng-container>

                        <!-- Disciplina -->
                        <ng-container matColumnDef="course">
                            <th mat-header-cell *matHeaderCellDef>Disciplina</th>
                            <td mat-cell *matCellDef="let element">{{ element.course?.name }}</td>
                        </ng-container>

                        <!-- Professor -->
                        <ng-container matColumnDef="teacher">
                            <th mat-header-cell *matHeaderCellDef>Professor</th>
                            <td mat-cell *matCellDef="let element">{{ element.course.teacher?.name }}</td>
                        </ng-container>

                        <!-- Status pesquisa aluno -->
                        <ng-container matColumnDef="hasResponded">
                            <th mat-header-cell *matHeaderCellDef>Respondida?</th>
                            <td mat-cell *matCellDef="let element">
                                <span *ngIf="element.hasResponded">Sim</span>
                                <span *ngIf="!element.hasResponded && element.status !== 'ABERTA'">Não</span>
                                <span *ngIf="!element.hasResponded && element.status == 'ABERTA'" style="color: red; font-weight: bold;">Não</span>
                            </td>
                        </ng-container>

                        <!-- Status -->
                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Status</th>
                            <td mat-cell *matCellDef="let element">
                                <ng-container [ngSwitch]="element.status">
                                    <span *ngSwitchCase="'ABERTA'" style="color: green; font-weight: bold;">Aberta</span>
                                    <span *ngSwitchCase="'ENCERRADA_PRAZO'">Prazo
                                        encerrado</span>
                                    <span *ngSwitchCase="'FINALIZADA'">Finalizada</span>
                                    <span *ngSwitchDefault>Desconhecido</span>
                                </ng-container>
                            </td>
                        </ng-container>

                        <!-- Respostas -->
                        <ng-container matColumnDef="totalAnswers">
                            <th mat-header-cell *matHeaderCellDef>Respostas</th>
                            <td mat-cell *matCellDef="let element">{{ element.totalAnswers }}</td>
                        </ng-container>

                        <!-- Deadline -->
                        <ng-container matColumnDef="deadline">
                            <th mat-header-cell *matHeaderCellDef>Deadline</th>
                            <td mat-cell *matCellDef="let element">{{ element.deadline | date:'dd/MM/yyyy HH:mm'}}</td>
                        </ng-container>

                        <!-- Criado em -->
                        <ng-container matColumnDef="createdAt">
                            <th mat-header-cell *matHeaderCellDef>Criado em</th>
                            <td mat-cell *matCellDef="let element">{{ element.createdAt | date:'dd/MM/yyyy HH:mm'}}</td>
                        </ng-container>

                        <!-- Atualizado em -->
                        <ng-container matColumnDef="updatedAt">
                            <th mat-header-cell *matHeaderCellDef>Atualizado em</th>
                            <td mat-cell *matCellDef="let element">{{ element.updatedAt | date:'dd/MM/yyyy HH:mm'}}</td>
                        </ng-container>

                        <!-- Linhas -->
                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="toggleRow(row)"
                            [class.selected]="selection.isSelected(row)"></tr>
                    </table>
                </div>

                <p *ngIf="searched && dataSource.data.length === 0" class="no-results">
                    Nenhuma pesquisa encontrada.
                </p>
            </section>
        </div>
    </div>